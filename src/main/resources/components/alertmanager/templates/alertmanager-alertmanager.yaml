apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  labels:
    alertmanager: main
  name: {{ include "alertmanager.fullname" . }}
spec:
  image: {{ .Values.image.alertmanager.repository }}:{{ .Values.image.alertmanager.tag }}
  {{- with .Values.nodeSelector }}
  nodeSelector:
    {{- toYaml . | nindent 8 }}
  {{- end }}
  affinity:
  {{- if eq .Values.podAntiAffinity "hard"}}
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: alertmanager
                operator: In
                values:
                  - main
          topologyKey: {{ .Values.podAntiAffinityTopologKey }}
    {{- else if eq .Values.podAntiAffinity "soft"}}
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            topologyKey: {{ .Values.podAntiAffinityTopologKey }}
            labelSelector:
              matchExpressions:
                - key: alertmanager
                  operator: In
                  values:
                    - main
  {{- end}}
    {{- with .Values.nodeAffinity }}
    nodeAffinity:
      {{- toYaml . | nindent 6 }}
    {{- end }}
  {{- with .Values.tolerations }}
  tolerations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  replicas: {{ .Values.replicas }}
  securityContext:
    fsGroup: 2000
    runAsNonRoot: true
    runAsUser: 1000
  serviceAccountName: {{ include "alertmanager.fullname" . }}
  version: v0.21.0
